---
- hosts: all
  become: true
  gather_facts: False
  pre_tasks:
    # Ansible requires python2, which is not installed by default on Ubuntu Xenial
    - raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
    # action: setup will gather facts after python2 has been installed
    - action: setup
  tasks:

   - name: install the mysql packages
     apt: name={{ item }} state=installed update_cache=yes
     with_items:
       - mysql-server
       - mysql-client
       - python-mysqldb

   - name: create database user (match)
     mysql_user: user={{mysql_user}} password={{mysql_pass}} host={{mysql_user_match_host}} priv=*.*:ALL state=present
   - name: create database user (data)
     mysql_user: user={{mysql_user}} password={{mysql_pass}} host={{mysql_user_data_host}} priv=*.*:ALL state=present


   - name: create database user (local)
     mysql_user: user={{mysql_user}} password={{mysql_pass}} host=localhost priv=*.*:ALL state=present

   - name: create database user (admin)
     mysql_user: user={{mysql_user}} password={{mysql_pass}} host={{admin_host}} priv=*.*:ALL state=present

   - name: set bind address
     lineinfile:
         dest: /etc/mysql/mysql.conf.d/mysqld.cnf
         regexp: '^bind-address            = 127.0.0.1'
         line: 'bind-address            = 0.0.0.0'

   - name: restart mysql
     service: name=mysql state=restarted

   - name: create databases
     mysql_db: db={{ item.dbname }} state=present
     with_items:
         - { dbname: 'trade_log' }
         - { dbname: 'trade_history' }

   - name: create tables
     shell: mysql -u {{ mysql_user }} -p{{ mysql_pass }} {{ item.dbname }} < {{ root_dir }}/sql/{{ item.file }}
     args:
       creates: /etc/mysql/tables_created
     with_items:
         - { dbname: 'trade_log', file: 'create_trade_log.sql' }
         - { dbname: 'trade_history', file: 'create_trade_history.sql' }

   # create evidence that previous step executed correctly
   - shell: touch /etc/mysql/tables_created

   - name: set user/pass in init_trade_history.sh
     lineinfile:
         dest: '{{ root_dir }}/sql/init_trade_history.sh'
         regexp: '{{ item.regexp }}'
         line: '{{ item.line }}'
     with_items:
         - { regexp: '^MYSQL_USER="user"', line: 'MYSQL_USER="{{ mysql_user }}"' }
         - { regexp: '^MYSQL_PASS="pass"', line: 'MYSQL_PASS="{{ mysql_pass }}"' }

   - name: init trade history
     shell: /bin/sh {{ root_dir }}/sql/init_trade_history.sh
     args:
       creates: /etc/mysql/trade_history_initialised

   # create evidence that previous step executed correctly
   - shell: touch /etc/mysql/trade_history_initialised
