---
- hosts: all
  become: true
  gather_facts: False
  pre_tasks:
    # Ansible requires python2, which is not installed by default on Ubuntu Xenial
    - raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
    # action: setup will gather facts after python2 has been installed
    - action: setup
  tasks:

    - include: build_viaxch.yml

    - name: create log directory
      file: path=/var/log/trade/ state=directory

    # using named groups due to ansible munging backrefs next to numbers (http://www.handverdrahtet.org/2016/01/ansible-using-numbered-backreference.html)
    - name:
      shell: perl -i -p0e 's/{{ item.regexp }}/{{ item.replace }}/s' {{root_dir}}/alertcenter/config.json
      with_items:
          - { regexp: '(?<one>"redis": \{[^\{]*"addr": \[[^\{]*")(127.0.0.1)(?<three>:26381",)',
              replace: '$+{one}{{redis_host}}$+{three}' }
          - { regexp: '(?<one>"redis": \{[^\{]*"addr": \[[^\{]*")(127.0.0.1)(?<three>:26382",)',
              replace: '$+{one}{{redis_host}}$+{three}' }
          - { regexp: '(?<one>"redis": \{[^\{]*"addr": \[[^\{]*")(127.0.0.1)(?<three>:26383")',
              replace: '$+{one}{{redis_host}}$+{three}' }

    - name: install python modules for send_alert.py
      apt: pkg={{item}} state=present
      with_items:
        - python-boto3
        - python-redis

    # using named groups due to ansible munging backrefs next to numbers (http://www.handverdrahtet.org/2016/01/ansible-using-numbered-backreference.html)
    - name:
      shell: perl -i -p0e 's/{{ item.regexp }}/{{ item.replace }}/s' {{root_dir}}/alertcenter/send_alert.py
      with_items:
          - { regexp: '(?<one>\[.)(yang\@haipo.me)(?<three>.\])',
              replace: '$+{one}{{alert_email | regex_replace("\@", "\\@")}}$+{three}' }
          - { regexp: '(?<one>\(")(192.168.0.62)(?<three>", )',
              replace: '$+{one}{{redis_host}}$+{three}' }
          - { regexp: '(?<one>", )(26379)(?<three>\),)',
              replace: '$+{one}{{26381}}$+{three}' }

    - name: install alertcenter_mailer systemd service
      template: src=templates/alertcenter_mailer.j2 dest=/etc/systemd/system/alertcenter_mailer.service

    - name: stop alertcenter_mailer
      systemd: state=stopped name=alertcenter_mailer
      ignore_errors: yes

    - name: start alertcenter_mailer
      systemd: state=started enabled=yes name=alertcenter_mailer daemon_reload=yes

    - name: install alertcenter systemd service
      template: src=templates/alertcenter.j2 dest=/etc/systemd/system/alertcenter.service

    - name: stop alertcenter
      systemd: state=stopped name=alertcenter
      ignore_errors: yes

    - name: start alertcenter
      systemd: state=started enabled=yes name=alertcenter daemon_reload=yes
